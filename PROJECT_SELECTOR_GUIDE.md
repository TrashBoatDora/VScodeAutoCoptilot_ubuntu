# 專案選擇器功能說明

## 📋 功能概述

新增的專案選擇器功能允許使用者在執行自動化腳本前，選擇要處理的專案，並可選擇性地清理這些專案的執行記錄。

---

## 🎯 主要變更

### 1. 新增模組

#### `src/project_selector_ui.py`
專案選擇器 UI 模組，提供圖形化的專案選擇介面。

**主要功能**:
- 掃描 `projects/` 目錄下的所有專案
- 顯示專案詳細資訊（Prompt 檔案、檔案數量、執行記錄）
- 支援複選專案
- 快速選擇功能（全選、全不選、反選）
- 可選擇是否清理執行記錄

**使用方式**:
```python
from src.project_selector_ui import show_project_selector

selected_projects, clean_history, cancelled = show_project_selector()
```

### 2. 修改模組

#### `src/ui_manager.py`
**主要變更**:
- 移除「重置專案狀態」勾選框
- 新增「瀏覽專案」按鈕
- 新增 `clean_project_history()` 方法清理專案記錄
- 更新 `show_options_dialog()` 返回值：
  - 舊版: `(是否重置, 是否使用智能等待)`
  - 新版: `(選中的專案集合, 是否使用智能等待, 是否清理歷史)`

**清理範圍**:
- `ExecutionResult/Success/` - 執行結果
- `ExecutionResult/AutomationLog/` - 自動化日誌
- `CWE_Result/` - CWE 掃描結果
- `cwe_scan_results/` - Bandit 原始報告

**備份機制**:
所有清理的檔案都會備份到 `backup_history_YYYYMMDD_HHMMSS/` 目錄。

#### `main.py`
**主要變更**:
- 更新 `run()` 方法以使用新的專案選擇機制
- 移除基於 `automation_status.json` 的專案過濾
- 直接使用使用者選定的專案列表
- 在處理前先清理選定專案的歷史記錄

---

## 🖥️ 使用流程

### 步驟 1: 啟動腳本
```bash
python main.py
```

### 步驟 2: 基本設定對話框
顯示第一個對話框，包含：
- **瀏覽專案按鈕**: 點擊後開啟專案選擇器
- **等待模式選擇**: 智能等待 vs 固定時間等待

### 步驟 3: 專案選擇器
點擊「瀏覽專案」按鈕後，顯示專案選擇器：

```
┌──────────────────────────────────────────────┐
│        選擇要處理的專案                       │
│     從 N 個可用專案中選擇                     │
├──────────────────────────────────────────────┤
│ 說明                                         │
│ • 勾選要執行自動化腳本的專案                 │
│ • 選定的專案將會清除先前的執行記錄           │
│ • 未選擇的專案將被跳過，不會處理             │
├──────────────────────────────────────────────┤
│ 可用專案                                     │
│ ┌────────────────────────────────────────┐ │
│ │ ☐ aider__CWE-022__CAL-ALL...            │ │
│ │   ✓ Prompt | 150 個檔案 | 📋 有執行記錄  │ │
│ │                                          │ │
│ │ ☐ ai-hedge-fund__CWE-022__CAL-ALL...    │ │
│ │   ✓ Prompt | 102 個檔案 | 📋 有執行記錄  │ │
│ └────────────────────────────────────────┘ │
├──────────────────────────────────────────────┤
│ 清理選項                                     │
│ ☑ 清除選定專案的執行記錄和結果（建議勾選）   │
│                                              │
│ [全選] [全不選] [反選]                       │
├──────────────────────────────────────────────┤
│ 已選擇: 0 個專案          [確認] [取消]      │
└──────────────────────────────────────────────┘
```

**功能說明**:
- **勾選框**: 選擇要處理的專案
- **快速選擇**: 全選、全不選、反選按鈕
- **清理選項**: 是否清除執行記錄（建議勾選）
- **統計資訊**: 顯示已選擇的專案數量

### 步驟 4: 確認選擇
點擊「確認」後，會顯示確認對話框：
```
確認選擇

您選擇了 N 個專案。

確認要處理這些專案嗎？

⚠️  將會清除這些專案的執行記錄和結果！

[是] [否]
```

### 步驟 5: 清理執行記錄
如果勾選了「清理執行記錄」，腳本會：
1. 建立備份目錄 `backup_history_YYYYMMDD_HHMMSS/`
2. 備份所有要清理的檔案
3. 刪除選定專案的執行記錄

輸出範例：
```
🧹 開始清理 2 個專案的執行記錄...
📦 建立備份到: backup_history_20251014_160000
  ✅ 已清理: 執行結果 - ai-hedge-fund__CWE-022__CAL-ALL-6b42874e__M-call
  ✅ 已清理: 自動化日誌 - ai-hedge-fund__CWE-022__CAL-ALL-6b42874e__M-call_automation_log_20251014_150328.txt
  ✅ 已清理: CWE掃描結果 - ai-hedge-fund__CWE-022__CAL-ALL-6b42874e__M-call_scan.csv

✅ 清理完成！共清理 3 個項目
📦 備份位置: backup_history_20251014_160000
```

### 步驟 6: 多輪互動設定
顯示多輪互動設定對話框（與之前相同）

### 步驟 7: CWE 掃描設定
顯示 CWE 掃描設定對話框（與之前相同）

### 步驟 8: 執行自動化
腳本僅處理選定的專案，跳過未選擇的專案。

---

## 🧪 測試

### 測試專案選擇器
```bash
python test_project_selector.py
```

### 測試完整 UI 流程
```bash
python test_ui_flow.py
```

---

## 📊 與舊版的差異

### 舊版流程
1. 顯示基本設定對話框（重置勾選框、等待模式）
2. 顯示多輪互動設定
3. 顯示 CWE 掃描設定
4. 處理 **所有** `pending` 狀態的專案

**問題**:
- 無法選擇要處理的專案
- 需要重置所有專案才能重新處理
- 依賴 `automation_status.json` 的 `status` 欄位

### 新版流程
1. 顯示基本設定對話框（**瀏覽專案按鈕**、等待模式）
2. 點擊瀏覽按鈕 → 專案選擇器（複選、清理選項）
3. 顯示多輪互動設定
4. 顯示 CWE 掃描設定
5. 清理選定專案的執行記錄
6. 處理 **選定的** 專案

**優點**:
- ✅ 靈活選擇要處理的專案
- ✅ 可選擇性清理執行記錄
- ✅ 不依賴 `automation_status.json`
- ✅ 支援重複處理同一專案
- ✅ 清理前自動備份

---

## 🔧 技術細節

### 專案掃描
`ProjectSelectorUI._scan_projects()` 掃描 `projects/` 目錄：
- 檢查 `prompt.txt` 是否存在
- 計算專案檔案數量
- 檢查是否有執行記錄

### 執行記錄檢查
`ProjectSelectorUI._check_execution_history()` 檢查：
- `ExecutionResult/Success/{project_name}/`
- `ExecutionResult/AutomationLog/{project_name}*.txt`
- `CWE_Result/CWE-*/{project_name}*`
- `cwe_scan_results/`

### 清理機制
`UIManager.clean_project_history()`:
1. 收集所有相關檔案和目錄
2. 建立時間戳記備份目錄
3. 逐一備份並刪除
4. 輸出詳細清理日誌

---

## 📝 相容性

### 保留的舊功能
- `UIManager.execute_reset_if_needed()` - 標記為已棄用但保留

### 移除的依賴
- 不再依賴 `automation_status.json` 的 `status` 欄位進行專案過濾
- 不再使用 `ProjectStatusReset.py` 進行全域重置

---

## 🎉 總結

新的專案選擇器功能提供了更靈活、更直觀的專案管理方式：

1. **精確控制**: 選擇要處理的專案，而非全部處理
2. **安全清理**: 自動備份，安心清理執行記錄
3. **友善介面**: 圖形化選擇，支援快速操作
4. **獨立執行**: 每個專案都可獨立重新執行

這使得測試和重複執行變得更加方便！🚀
