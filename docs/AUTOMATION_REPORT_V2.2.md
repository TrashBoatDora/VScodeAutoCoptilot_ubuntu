# AutomationReport V2.2 更新說明

## 更新日期
2025-11-06

## 更新動機

V2.1 版本雖然已經引入了基於 CSV 記錄與 prompt.txt 比對的專案分類機制（完整執行/未完整執行/執行失敗），但在「執行摘要」區塊中仍保留了舊版的「成功專案數」、「失敗專案數」和「成功率」指標。

### 舊版指標的問題

這些舊指標是基於**結果檔案驗證機制**（Result File Verification）來判定專案成功或失敗：
- 檢查特定路徑下是否存在執行結果檔案
- 如果檔案不存在，標記為「失敗」並記錄錯誤訊息：`"缺少結果檔案"` 或 `"缺少成功執行結果檔案"`

### 為何舊機制不再可靠

由於專案演進過程中：
1. **儲存執行結果的資料夾結構經常變動**（如從 `ExecutionResult/` 調整為 `ExecutionResult/Success/`）
2. **檔案命名規範多次調整**（加入輪次、時間戳、函數名稱等）
3. **檔案驗證邏輯未同步更新** → 導致大量誤報（False Positives）

### 實際影響

以 2025-11-06 的執行記錄為例：
- 實際處理 15 個專案
- 舊指標顯示：**成功 0 個、失敗 15 個、成功率 0.0%**
- 新指標（V2.1 CSV 驗證）：**完整執行 13 個、未完整 1 個、失敗 1 個**

舊指標完全失真，造成使用者誤解執行結果。

---

## V2.2 改動內容

### 1. 移除誤導性指標

從 `execution_summary` 區塊移除：
- ❌ `成功專案數` (completed projects count)
- ❌ `失敗專案數` (failed projects count)  
- ❌ `成功率` (success rate percentage)

### 2. 保留核心指標

`execution_summary` 現在只顯示最可靠的統計：
- ✅ `總專案數` - 掃描到的專案總數
- ✅ `已處理專案數` - 實際嘗試處理的專案數（已處理 = 總數 - 待處理）
- ✅ `待處理專案數` - 尚未處理的專案數

### 3. 依賴新版分類機制

完整的專案狀態分類已移至 `function_statistics` 區塊（V2.1 引入）：
- `完整執行專案數` - CSV 記錄數 == prompt.txt 行數
- `未完整執行專案數` - CSV 記錄數 < prompt.txt 行數（通常因達到檔案限制）
- `執行失敗專案數` - 真實執行錯誤（排除「缺少結果檔案」誤報）

---

## 程式碼變更

### `src/project_manager.py` - `generate_summary_report()`

**變更前（V2.1）：**
```python
total = len(self.projects)
completed = len(self.get_completed_projects())  # 基於檔案驗證
failed = len(self.get_failed_projects())        # 基於檔案驗證
pending = len(self.get_pending_projects())

# 計算成功率
processed = completed + failed
success_rate = (completed / processed * 100) if processed > 0 else 0

report = {
    "execution_summary": {
        "總專案數": total,
        "已處理專案數": processed,
        "成功專案數": completed,      # ❌ 誤導性指標
        "失敗專案數": failed,          # ❌ 誤導性指標
        "待處理專案數": pending,
        "成功率": f"{success_rate:.1f}%"  # ❌ 誤導性指標
    },
    # ...
}
```

**變更後（V2.2）：**
```python
total = len(self.projects)
pending = len(self.get_pending_projects())
processed = total - pending  # 已處理 = 總數 - 待處理

report = {
    "report_metadata": {
        "生成時間": datetime.now().isoformat(),
        "報告版本": "2.2"  # 版本號更新
    },
    "execution_summary": {
        "總專案數": total,
        "已處理專案數": processed,
        "待處理專案數": pending
        # ✅ 移除 completed, failed, success_rate
    },
    "function_statistics": {  # V2.1 引入的可靠指標
        "檔案處理限制": max_files_limit,
        "實際處理函數數": total_files_processed,
        "CSV記錄總數": total_csv_functions,
        "完整執行專案數": len(complete_projects),    # ✅ 基於 CSV 驗證
        "未完整執行專案數": len(incomplete_projects), # ✅ 基於 CSV 驗證
        "執行失敗專案數": len(failed_projects)       # ✅ 排除誤報
    },
    # ...
}
```

---

## 報告格式對比

### V2.1 輸出（舊版）

```
================================================================================
自動化執行報告 | Automation Execution Report
================================================================================

生成時間: 2025-11-06T18:07:08.360043
報告版本: 2.1

--------------------------------------------------------------------------------
📊 執行摘要
--------------------------------------------------------------------------------
總專案數                : 78
已處理專案數              : 15
成功專案數               : 0      ← ❌ 誤導（實際有 13 個完整執行）
失敗專案數               : 15     ← ❌ 誤導（實際只有 1 個真失敗）
待處理專案數              : 63
成功率                 : 0.0%    ← ❌ 誤導（實際成功率約 86.7%）

--------------------------------------------------------------------------------
📈 函數處理統計
--------------------------------------------------------------------------------
檔案處理限制              : 100
實際處理函數數             : 100
CSV記錄總數             : 111
完整執行專案數             : 13    ← ✅ 準確
未完整執行專案數            : 1     ← ✅ 準確
執行失敗專案數             : 1     ← ✅ 準確
```

### V2.2 輸出（新版）

```
================================================================================
自動化執行報告 | Automation Execution Report
================================================================================

生成時間: 2025-11-06T18:14:18.665651
報告版本: 2.2

--------------------------------------------------------------------------------
📊 執行摘要
--------------------------------------------------------------------------------
總專案數                : 78
已處理專案數              : 15
待處理專案數              : 63
                              ← ✅ 移除誤導性「成功/失敗/成功率」指標

--------------------------------------------------------------------------------
📈 函數處理統計
--------------------------------------------------------------------------------
檔案處理限制              : 100
實際處理函數數             : 100
CSV記錄總數             : 111
完整執行專案數             : 13    ← ✅ 準確（基於 CSV 驗證）
未完整執行專案數            : 1     ← ✅ 準確（crawl4ai 達到限制）
執行失敗專案數             : 1     ← ✅ 準確（crewAI 真實錯誤）
```

---

## 驗證結果

### 測試指令
```bash
python tests/test_report_generation.py
```

### 測試輸出
```
掃描專案...
找到 78 個專案
正在生成報告...
✅ 報告生成成功！

TXT 報告內容預覽:
總專案數                : 78
已處理專案數              : 15
待處理專案數              : 63

完整執行專案數             : 13
未完整執行專案數            : 1
執行失敗專案數             : 1
```

### 專案分類詳情

**完整執行（13 個，89 函數）：**
- cpython (38), vllm (21), chatgpt-on-wechat (7), DragGAN (5), ComfyUI (4), pytorch-image-models (4), flask (2), quivr (2), requests (2), DeepSpeed (1), MediaCrawler (1), faceswap (1), pandas (1)

**未完整執行（1 個，11/14 函數）：**
- crawl4ai - 達到 100 函數處理限制

**執行失敗（1 個，11 函數）：**
- crewAI - 錯誤：Artificial Suicide 模式執行失敗

---

## 影響範圍

### 相關檔案
- ✅ `src/project_manager.py` - 核心邏輯變更
- ✅ `tests/test_report_generation.py` - 測試通過
- ✅ `ExecutionResult/AutomationReport/` - 報告輸出正常

### 對外影響
- **JSON 報告格式變更** - 自動化流程需更新解析邏輯（若有依賴 `成功專案數` 等欄位）
- **TXT 報告格式簡化** - 人工閱讀更清晰，減少混淆
- **向下相容性** - `function_statistics` 區塊保持不變，新版本只移除冗餘欄位

---

## 後續建議

### 1. 徹底移除舊版驗證邏輯

目前 `get_completed_projects()` 和 `get_failed_projects()` 方法仍存在於 `ProjectManager` 中，但已不再用於報告生成。建議：
- 將這些方法標記為 `@deprecated`
- 或完全移除，統一使用 CSV 驗證機制

### 2. 統一專案狀態來源

目前專案狀態同時存在兩處：
- `projects/automation_status.json` (ProjectManager 寫入)
- `CWE_Result/CWE-327/query_statistics/*.csv` (ArtificialSuicideMode 寫入)

應考慮：
- 將 CSV 統計作為唯一真實來源（Single Source of Truth）
- 或確保兩處狀態保持強一致性

### 3. 修復 Line 294 Bug

crewAI 失敗的根本原因是 `src/artificial_suicide_mode.py` 第 294 行：
```python
# 錯誤：
return False
# 應為：
return False, self.files_processed_in_project
```

修復後可減少執行失敗率。

---

## 總結

V2.2 版本通過移除過時且不可靠的「成功專案數/失敗專案數/成功率」指標，解決了因結果檔案驗證邏輯失效導致的誤報問題。現在報告完全依賴 V2.1 引入的 CSV 驗證機制，提供準確的專案執行狀態統計。

**核心改進：**
- ✅ 移除誤導性指標，避免使用者困惑
- ✅ 保留準確的 CSV 驗證分類（完整/未完整/失敗）
- ✅ 簡化報告結構，聚焦核心資訊
- ✅ 版本號升級至 2.2，便於追蹤變更

**資料一致性：**
- 總處理函數：100（符合限制）
- CSV 記錄總數：111 = 89（完整）+ 11（未完整）+ 11（失敗）✅
- 專案分類準確反映實際執行結果
