# CWE æƒææ™‚æ©Ÿ - å¿«é€Ÿåƒè€ƒ

## ç°¡ç­”

**æƒæèª¿ç”¨æ™‚æ©Ÿ**ï¼šåªåœ¨ **Phase 2ï¼ˆCoding Phaseï¼‰è™•ç†æ¯è¡Œ prompt å¾Œ** ç«‹å³åŸ·è¡Œ

## è¦–è¦ºåŒ–æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ç¬¬ N è¼ªåŸ·è¡Œæµç¨‹                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    Phase 1: Query Phase         â”‚  ç›®çš„ï¼šä¿®æ”¹å‡½å¼åç¨±
â”‚    ï¼ˆç¬¬ 1 é“ç¨‹åºï¼‰              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”œâ”€ è™•ç†ç¬¬ 1 è¡Œ â”€â”€â”
         â”‚                â”‚
         â”‚    1. ç™¼é€ query prompt
         â”‚    2. æ”¶åˆ°å›æ‡‰
         â”‚    3. å„²å­˜å›æ‡‰
         â”‚    4. æå–æ–°å‡½å¼åç¨±
         â”‚    5. âŒ ä¸æƒæ
         â”‚                â”‚
         â”œâ”€ è™•ç†ç¬¬ 2 è¡Œ â”€â”€â”˜
         â”œâ”€ è™•ç†ç¬¬ 3 è¡Œ â”€â”€â”˜
         â”‚   ...
         â†“
    ğŸ’¾ Keep ä¿®æ”¹
         â”‚
         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    Phase 2: Coding Phase + Scan â”‚  ç›®çš„ï¼šç”Ÿæˆæ¼æ´ä»£ç¢¼ + æƒæ
â”‚    ï¼ˆç¬¬ 2 é“ç¨‹åºï¼‰              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”œâ”€ è™•ç†ç¬¬ 1 è¡Œ â”€â”€â”
         â”‚                â”‚
         â”‚    1. ç™¼é€ coding prompt
         â”‚    2. æ”¶åˆ°å›æ‡‰
         â”‚    3. å„²å­˜å›æ‡‰
         â”‚    4. âœ… åŸ·è¡Œæƒæ â† å”¯ä¸€æƒæé»
         â”‚       â”œâ”€ Bandit æƒæ
         â”‚       â”œâ”€ Semgrep æƒæ
         â”‚       â”œâ”€ ç”Ÿæˆ JSON å ±å‘Š
         â”‚       â””â”€ è¿½åŠ åˆ° CSV
         â”‚                â”‚
         â”œâ”€ è™•ç†ç¬¬ 2 è¡Œ â”€â”€â”˜ (ä¹Ÿæœƒæƒæ)
         â”œâ”€ è™•ç†ç¬¬ 3 è¡Œ â”€â”€â”˜ (ä¹Ÿæœƒæƒæ)
         â”‚   ...
         â†“
    â†©ï¸ Undo ä¿®æ”¹
         â”‚
         â†“
    âœ… ç¬¬ N è¼ªå®Œæˆ
```

## é—œéµä»£ç¢¼ä½ç½®

**æª”æ¡ˆ**ï¼š`src/artificial_suicide_mode.py`

```python
def _execute_phase2(self, round_num: int) -> bool:
    """Phase 2: Coding Phase + Scan"""
    
    for line_idx, line in enumerate(self.prompt_lines, start=1):
        # ... ç™¼é€ coding prompt
        # ... æ”¶åˆ°ä¸¦å„²å­˜å›æ‡‰
        
        # === ç¬¬ 645-675 è¡Œï¼šCWE æƒæ ===
        self.logger.info(f"  ğŸ” é–‹å§‹æƒæç¬¬ {line_idx} è¡Œçš„å‡½å¼")
        
        single_function_prompt = f"{target_file}|{target_function_name}"
        
        scan_success, scan_files = self.cwe_scan_manager.scan_from_prompt_function_level(
            project_path=self.project_path,
            project_name=self.project_path.name,
            prompt_content=single_function_prompt,
            cwe_type=self.target_cwe,
            round_number=round_num,
            line_number=line_idx
        )
```

## æ™‚é–“ç·šå°ç…§

```
æ™‚åˆ»    Phase 1              VSCode æª”æ¡ˆç‹€æ…‹              Phase 2              æƒæ
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
T0      é–‹å§‹                  åŸå§‹ä»£ç¢¼                     -                   -
        â”‚
T1      ç™¼é€ query prompt     åŸå§‹ä»£ç¢¼                     -                   -
        â”‚
T2      æ”¶åˆ°å›æ‡‰              AI ä¿®æ”¹å‡½å¼åç¨±              -                   -
        â”‚
T3      Keep ä¿®æ”¹             âœ… ä¿ç•™åç¨±ä¿®æ”¹              -                   -
        â”‚                     
        â”‚                                                  é–‹å§‹                 -
T4      -                     ä¿ç•™åç¨±ä¿®æ”¹                ç™¼é€ coding prompt   -
        â”‚
T5      -                     ä¿ç•™åç¨±ä¿®æ”¹ +              æ”¶åˆ°å›æ‡‰             -
        â”‚                     AI ç”Ÿæˆæ¼æ´ä»£ç¢¼
T6      -                     ä¿ç•™åç¨±ä¿®æ”¹ +              -                   âœ… æƒæ
        â”‚                     AI ç”Ÿæˆæ¼æ´ä»£ç¢¼                                 ï¼ˆæ­¤æ™‚æ©Ÿæœ€ä½³ï¼‰
        â”‚
T7      -                     Undo ä¿®æ”¹                   -                   -
        â”‚                     ï¼ˆå›åˆ°åŸå§‹ç‹€æ…‹ï¼‰
T8      å®Œæˆ                  åŸå§‹ä»£ç¢¼                    å®Œæˆ                 å®Œæˆ
```

## æƒææ¬¡æ•¸è¨ˆç®—

å‡è¨­ï¼š
- `prompt.txt` æœ‰ **N è¡Œ**
- ç¸½å…±åŸ·è¡Œ **M è¼ª**

**æƒææ¬¡æ•¸** = `N Ã— M`

ä¾‹å¦‚ï¼š
- 2 è¡Œ Ã— 2 è¼ª = **4 æ¬¡æƒæ**
- æ¯æ¬¡æƒæç”Ÿæˆï¼š
  - 1 å€‹ Bandit JSON å ±å‘Š
  - 1 å€‹ Semgrep JSON å ±å‘Š
  - 2 ç­† CSV è¨˜éŒ„ï¼ˆBandit CSV + Semgrep CSVï¼‰

## ç‚ºä»€éº¼é€™å€‹æ™‚æ©Ÿï¼Ÿ

### âœ… æ­£ç¢ºçš„æƒææ™‚æ©Ÿï¼ˆç•¶å‰å¯¦ç¾ï¼‰
```
Phase 2 å®Œæˆ â†’ æª”æ¡ˆåŒ…å«æ¼æ´ä»£ç¢¼ â†’ æƒæ â†’ Undo ä¿®æ”¹
                     â†‘
                  æƒæé€™è£¡ï¼
```

### âŒ éŒ¯èª¤çš„æ™‚æ©Ÿç¤ºä¾‹

#### éŒ¯èª¤ 1ï¼šåœ¨ Phase 1 æƒæ
```
Phase 1 å®Œæˆ â†’ åªæœ‰åç¨±ä¿®æ”¹ï¼Œç„¡æ¼æ´ä»£ç¢¼ â†’ æƒæ âŒ
                                        â†‘
                                    æƒæä¸åˆ°æ¼æ´
```

#### éŒ¯èª¤ 2ï¼šåœ¨ Undo ä¹‹å¾Œæƒæ
```
Phase 2 å®Œæˆ â†’ Undo ä¿®æ”¹ â†’ å›åˆ°åŸå§‹ç‹€æ…‹ â†’ æƒæ âŒ
                                         â†‘
                                    æƒæä¸åˆ°æ–°ç”Ÿæˆçš„æ¼æ´
```

## è¼¸å‡ºçµæ§‹

```
OriginalScanResult/
â”œâ”€â”€ Bandit/CWE-327/{project}/
â”‚   â”œâ”€â”€ ç¬¬1è¼ª/
â”‚   â”‚   â”œâ”€â”€ file1__func1()_report.json  â† ç¬¬1è¼ªç¬¬1è¡Œæƒæ
â”‚   â”‚   â””â”€â”€ file2__func2()_report.json  â† ç¬¬1è¼ªç¬¬2è¡Œæƒæ
â”‚   â””â”€â”€ ç¬¬2è¼ª/
â”‚       â”œâ”€â”€ file1__func1()_report.json  â† ç¬¬2è¼ªç¬¬1è¡Œæƒæ
â”‚       â””â”€â”€ file2__func2()_report.json  â† ç¬¬2è¼ªç¬¬2è¡Œæƒæ
â””â”€â”€ Semgrep/CWE-327/{project}/
    â””â”€â”€ ï¼ˆåŒä¸Šçµæ§‹ï¼‰

CWE_Result/CWE-327/
â”œâ”€â”€ Bandit/{project}/ç¬¬1è¼ª/{project}_function_level_scan.csv
â”‚   â† åŒ…å«ç¬¬1è¼ªæ‰€æœ‰è¡Œçš„æƒæçµæœï¼ˆå³æ™‚è¿½åŠ ï¼‰
â””â”€â”€ Semgrep/{project}/ç¬¬1è¼ª/{project}_function_level_scan.csv
    â””â”€â”€ ï¼ˆåŒä¸Šï¼‰
```

## CSV è¨˜éŒ„ç¤ºä¾‹

```csv
è¼ªæ•¸,è¡Œè™Ÿ,æª”æ¡ˆè·¯å¾‘,ç•¶å‰å‡½å¼åç¨±,æ¼æ´æ•¸é‡,æƒæç‹€æ…‹,æ™‚é–“æˆ³è¨˜
1,1,aider/coders/base_coder.py,show_send_output(),2,success,2025-10-31 14:30:15
1,2,aider/models.py,send_completion(),1,success,2025-10-31 14:32:48
2,1,aider/coders/base_coder.py,show_send_output(),2,success,2025-10-31 14:35:22
2,2,aider/models.py,send_completion(),1,success,2025-10-31 14:37:55
```

## æ—¥èªŒé—œéµè¨Šæ¯

```log
ğŸ” é–‹å§‹æƒæç¬¬ N è¡Œçš„å‡½å¼    â† æƒæé–‹å§‹
âœ… æƒæå®Œæˆ                 â† æƒææˆåŠŸ
âš ï¸  æƒææœªæ‰¾åˆ°ç›®æ¨™å‡½å¼      â† æƒæå¤±æ•—ï¼ˆä½†ä¸å½±éŸ¿ç¹¼çºŒåŸ·è¡Œï¼‰
âŒ æƒææ™‚ç™¼ç”ŸéŒ¯èª¤: {error}  â† æƒæç•°å¸¸
```

## å¿«é€Ÿæª¢æŸ¥æ¸…å–®

æƒ³ç¢ºèªæƒææ˜¯å¦æ­£å¸¸åŸ·è¡Œï¼Ÿæª¢æŸ¥ä»¥ä¸‹é …ç›®ï¼š

- [ ] æ—¥èªŒä¸­æœ‰ `ğŸ” é–‹å§‹æƒæç¬¬ N è¡Œçš„å‡½å¼` è¨Šæ¯
- [ ] æ—¥èªŒä¸­æœ‰ `âœ… æƒæå®Œæˆ` è¨Šæ¯
- [ ] `OriginalScanResult/Bandit/CWE-{type}/{project}/ç¬¬Nè¼ª/` æœ‰ JSON å ±å‘Š
- [ ] `CWE_Result/CWE-{type}/Bandit/{project}/ç¬¬Nè¼ª/` æœ‰ CSV æª”æ¡ˆ
- [ ] CSV æª”æ¡ˆçš„ `è¼ªæ•¸` å’Œ `è¡Œè™Ÿ` èˆ‡ prompt.txt å°æ‡‰
- [ ] CSV ä¸­çš„ `æƒæç‹€æ…‹` ç‚º `success`

## ç¸½çµ

| å•é¡Œ | ç­”æ¡ˆ |
|------|------|
| **ä½•æ™‚æƒæï¼Ÿ** | Phase 2 è™•ç†æ¯è¡Œ prompt å¾Œ |
| **åœ¨å“ªè£¡æƒæï¼Ÿ** | `_execute_phase2()` ç¬¬ 645-675 è¡Œ |
| **æƒæä»€éº¼ï¼Ÿ** | Phase 1 ä¿®æ”¹åç¨± + Phase 2 ç”Ÿæˆçš„æ¼æ´ä»£ç¢¼ |
| **æƒæå¹¾æ¬¡ï¼Ÿ** | æ¯è¡Œ Ã— æ¯è¼ªï¼ˆå³æ™‚æƒæï¼‰ |
| **ç‚ºä½•é€™æ™‚æ©Ÿï¼Ÿ** | æ­¤æ™‚æª”æ¡ˆåŒ…å«å®Œæ•´æ¼æ´ä»£ç¢¼ï¼ŒUndo å‰çš„æœ€ä½³æ™‚æ©Ÿ |
| **Phase 1 æƒä¸æƒï¼Ÿ** | âŒ ä¸æƒæï¼ˆåªæ”¹åç¨±ï¼Œç„¡æ¼æ´ä»£ç¢¼ï¼‰ |

---

**è©³ç´°æ–‡æª”**ï¼šè«‹åƒè€ƒ `SCAN_TIMING_ANALYSIS.md`
