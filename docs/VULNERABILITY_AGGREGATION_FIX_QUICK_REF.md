# 漏洞聚合功能修復 - 快速參考

## 修復內容

✅ **修復日期**: 2025-11-07  
✅ **影響範圍**: AS模式 & 非AS模式的CSV輸出  
✅ **核心文件**: `src/cwe_scan_manager.py`

---

## 修復前後對比

### 修復前（錯誤）
同一函式的多個漏洞會產生**多列記錄**：

```csv
輪數,行號,檔案路徑,函式名稱,漏洞數量,漏洞行號
1,1,src/auth.py,build_digest_header,1,144
1,1,src/auth.py,build_digest_header,1,146
1,1,src/auth.py,build_digest_header,1,163
```
→ **3列記錄，漏洞數量都是1**

### 修復後（正確）
同一函式的多個漏洞會**聚合成單列記錄**：

```csv
輪數,行號,檔案路徑,函式名稱,漏洞數量,漏洞行號
1,1,src/auth.py,build_digest_header,3,"144,146,163"
```
→ **1列記錄，漏洞數量為3，行號逗號分隔**

---

## 修復邏輯

在 `_save_function_level_csv()` 中：

1. **收集所有漏洞行號** → 去重並排序
2. **計算漏洞總數** → `len(func_vulns)`
3. **聚合元數據** → 掃描器、信心度、嚴重性、描述
4. **寫入單一列** → 而非為每個漏洞寫一列

---

## CSV欄位格式

| 欄位 | 格式 | 範例 |
|------|------|------|
| 漏洞數量 | 整數 | `3` |
| 漏洞行號 | 逗號分隔 | `144,146,163` |
| 掃描器 | 分號分隔（多個） | `bandit;semgrep` |
| 信心度 | 分號分隔（多個） | `HIGH;MEDIUM` |
| 嚴重性 | 分號分隔（多個） | `HIGH` |
| 問題描述 | 管道分隔（多個） | `desc1 \| desc2 \| desc3` |

---

## 測試驗證

```bash
# 測試已通過，測試腳本已清理
✅ 非AS模式測試通過
✅ AS模式測試通過（含修改前/後函式名稱）
```

---

## 影響的CSV文件

修復後，以下路徑的CSV文件將採用新格式：

```
CWE_Result/CWE-{type}/Bandit/{project}/第N輪/{project}_function_level_scan.csv
CWE_Result/CWE-{type}/Semgrep/{project}/第N輪/{project}_function_level_scan.csv
```

---

## 常見問題

**Q: 舊的CSV文件會被自動更新嗎？**  
A: 不會。需要重新執行掃描才會產生新格式的CSV。

**Q: 這會影響 query_statistics.py 嗎？**  
A: 不會。統計邏輯會正確讀取聚合後的「漏洞數量」欄位。

**Q: 追加模式（append_mode）仍然有效嗎？**  
A: 是的。逐行掃描時仍然可以追加寫入，每行會產生一列聚合記錄。

---

## 相關文檔

- 詳細文檔: `docs/VULNERABILITY_AGGREGATION_FIX.md`
- 原始指南: `.github/copilot-instructions.md`
